name: Deploy by Version

on:
  workflow_dispatch:
    inputs:
      version:
        description: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Docker Compose Version"
        required: true
        type: choice
        options:
          - version1.0
          - version2.0
          - version3.0

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üìÇ Checkout Code
        uses: actions/checkout@v3

      - name: üöÄ Deploy version ${{ github.event.inputs.version }}
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            VERSION=${{ github.event.inputs.version }}

            echo "üì¶ ‡πÄ‡∏£‡∏¥‡πà‡∏° deploy version: $VERSION"

            # ‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå repo ‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô
            rm -rf ~/docker-deploy
            git clone https://github.com/${{ github.repository }}.git ~/docker-deploy

            cd ~/docker-deploy
            git checkout ${{ github.ref_name }}
            cd docker-compose/$VERSION

            echo "üõë ‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏•‡∏ö container ‡πÄ‡∏î‡∏¥‡∏°"
            docker-compose down --remove-orphans || true

            echo "üßπ ‡∏•‡∏ö container ‡∏ä‡∏∑‡πà‡∏≠ fix ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
            docker rm -f postgres_db || true
            docker rm -f webapi_container || true
            docker rm -f webapp_container || true

            echo "üì• ‡∏î‡∏∂‡∏á image ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î"
            docker-compose pull

            echo "üöÄ ‡∏£‡∏±‡∏ô container ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏ö‡∏ö clean"
            docker-compose up -d --build

            echo "‚úÖ Deploy ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à version: $VERSION"
